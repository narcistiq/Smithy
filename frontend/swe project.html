<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smithy</title>
    <link rel="stylesheet" href="swe project.css">
</head>
<body>
    <div id="root"></div>
<script src = "https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src = "https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState } = React;
        const MATERIALS = {
            stone: "./materials/stone.png",
            wood: "./materials/wood.png",
            water: "./materials/water.png",
        }
        function Sidebar({onDragStart}){
            return(
                <aside id="sidebar" className="page-content" aria-label="Component sidebar">
                    <h3>Materials</h3>
                    <div className="sidebar-list">
                        {Object.entries(MATERIALS).map(([name,src])=>(   
                            <div className="items" key={name}>  
                                <img 
                                    className="draggable" 
                                    src={src}
                                    key={name}
                                    alt={name}
                                    draggable="true" 
                                    onDragStart={(e)=>onDragStart(e,name)}
                                />
                                <p className="item-name">{name}</p>  
                            </div>
                        ))}
        
                    </div>
                </aside>
            );
        }

        function Workspace({workspaceItems, onDrop, onDragOver, onItemDrag, onItemDrop}){
            return(

                <main id="workspace" className="page-content" tabIndex="0" aria-label="Workspace (drop area)"
                    onDrop={onDrop}
                    onDragOver={onDragOver}>
                    {workspaceItems.length === 0 ? (
                        <p className="workspace-placeholder"><b>Drag items here</b></p>
                    ) : (workspaceItems.map((item,i) => (
                        <img 
                            src={`./materials/${item.name}.png`}
                            key={i} 
                            className="workspace-item"
                            style={{
                                position: 'absolute',
                                left: `${item.x}px`,
                                top: `${item.y}px`,
                                cursor: 'move'
                            }}
                            draggable="true"
                            onDragStart={(e) => onItemDrag(e, i)}
                            onDragOver={(e) => e.preventDefault()}
                            onDrop={(e) => onItemDrop(e, i)}
                        />
                    )))}
                </main>
            );
        }
        function LoginModal({ isOpen, onClose, onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showForgotPassword, setShowForgotPassword] = useState(false);
            const [email, setEmail] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (username && password) {
                    onLogin(username, password);
                    setUsername('');
                    setPassword('');
                    onClose();
                } else {
                    alert('Please enter both username and password');
                }
            };

            const handleForgotPassword = (e) => {
                e.preventDefault();
                if (email) {
                    alert(`Password reset link sent to: ${email}`);
                    setEmail('');
                    setShowForgotPassword(false);
                } else {
                    alert('Please enter your email address');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2 className="modal-title">‚öîÔ∏è Return to thy Realm ‚öîÔ∏è</h2>
                        
                        {!showForgotPassword ? (
                            <form onSubmit={handleLogin}>
                                <div className="form-group">
                                    <label className="form-label">Username:</label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="form-input"
                                        placeholder="Enter thy username"
                                    />
                                </div>
                                <div className="form-group" style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Password:</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="form-input"
                                        placeholder="Enter thy secret word"
                                    />
                                </div>
                                <div className="btn-container">
                                    <button type="submit" className="btn-primary">
                                        üó°Ô∏è Enter
                                    </button>
                                    <button type="button" onClick={onClose} className="btn-secondary">
                                        ‚ùå Cancel
                                    </button>
                                </div>
                                <button
                                    type="button"
                                    onClick={() => setShowForgotPassword(true)}
                                    className="forgot-password-btn"
                                >
                                    <b>üîë Forgot thy password?</b>
                                </button>
                            </form>
                        ) : (
                            <form onSubmit={handleForgotPassword}>
                                <div className="form-group" style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Email Address:</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="form-input"
                                        placeholder="Enter thy email address"
                                    />
                                </div>
                                <div className="btn-container">
                                    <button type="submit" className="btn-primary">
                                         Send Reset Link
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setShowForgotPassword(false)}
                                        className="btn-secondary"
                                    >
                                         Back
                                    </button>
                                </div>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        function App(){
            const [workspaceItems, setWorkspaceItems] = useState([]);
            const [draggingIndex, setDraggingIndex] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState('');
            const [showLoginModal, setShowLoginModal] = useState(false);
            
            const handleDragStart = (e, item) => {
                e.dataTransfer.setData("text/plain", item);
                e.dataTransfer.effectAllowed = "copy";
            };
            
            const handleItemDrag = (e, index) => {
                setDraggingIndex(index);
                const item = workspaceItems[index];
                if (item) e.dataTransfer.setData('text/plain', item.name);
                e.dataTransfer.effectAllowed = "move";
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                const workspace = document.getElementById("workspace");
                const rect = workspace.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (draggingIndex !== null) {
                    setWorkspaceItems((prevItems) => {
                        const newItems = [...prevItems];
                        newItems[draggingIndex] = {
                            ...newItems[draggingIndex],
                            x: x - 50, 
                            y: y - 20
                        };
                        return newItems;
                    });
                    setDraggingIndex(null);
                } else {
                    const item = e.dataTransfer.getData("text/plain");
                    if (item) {
                        setWorkspaceItems((prevItems) => [...prevItems, {
                            name: item,
                            x: x - 50,
                            y: y - 20
                        }]);
                    }
                }
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
            };
            const API_BASE = 'http://localhost:8000/api';
            const [message, setMessage] = useState('');

            function showMessage(msg){
                setMessage(msg);
                setTimeout(()=> setMessage(''), 3500);
            }

            const handleLogin = (username, password) => {
                setCurrentUser(username);
                setIsLoggedIn(true);
                showMessage(`Welcome to the realm, ${username}!`);
            };

            const handleLogout = () => {
                setCurrentUser('');
                setIsLoggedIn(false);
                showMessage('Thou hast left the realm.');
            };

            // called when a workspace item has another item dropped onto it
            const handleItemDrop = async (e, targetIndex) => {
                e.preventDefault();
                const otherName = e.dataTransfer.getData('text/plain');
                if (!otherName) return;
                const target = workspaceItems[targetIndex];
                if (!target || target.name === otherName) return;

                try{
                    const resp = await fetch(API_BASE + '/combine/', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ item1_name: target.name, item2_name: otherName })
                    });
                    const data = await resp.json();
                    if (resp.ok){
                        showMessage(data.message || JSON.stringify(data));
                        if (data.is_new && data.new_item){
                            // add new item near the target
                            setWorkspaceItems(prev => [...prev, {
                                name: data.new_item,
                                x: (target.x || 0) + 40,
                                y: (target.y || 0) + 10
                            }]);
                        }
                    } else {
                        showMessage('Error: ' + (data.error || resp.statusText));
                    }
                } catch(err){
                    showMessage('Network error: ' + err.message);
                }
            };
           return(
            <React.Fragment>
                {/* Login Button */}
                <div className="login-container">
                    {!isLoggedIn ? (
                        <button
                            onClick={() => setShowLoginModal(true)}
                            className="login-btn"
                        >
                            üè∞ Enter thy Realm
                        </button>
                    ) : (
                        <div className="user-status">
                            <span className="user-name">üëë {currentUser}</span>
                            <button
                                onClick={handleLogout}
                                className="logout-btn"
                            >
                                üö™ Logout
                            </button>
                        </div>
                    )}
                </div>

                <Sidebar onDragStart={handleDragStart}/>
                <Workspace 
                    workspaceItems={workspaceItems}
                    onDrop={handleDrop}
                    onDragOver={handleDragOver}
                    onItemDrag={handleItemDrag}
                    onItemDrop={handleItemDrop}
                />  
                
                {/* Login Modal */}
                <LoginModal 
                    isOpen={showLoginModal} 
                    onClose={() => setShowLoginModal(false)}
                    onLogin={handleLogin}
                />
                
                {message && (
                    <div id="api-message-box" style={{
                        position: 'fixed',
                        right: '16px',
                        bottom: '16px',
                        padding: '10px 14px',
                        background: 'rgba(0,0,0,0.8)',
                        color: '#fff',
                        borderRadius: '6px',
                        zIndex: 9999
                    }}>{message}</div>
                )}
            </React.Fragment>);
           
        }
        const container=document.getElementById("root");
        const root=ReactDOM.createRoot(container);
        root.render(<App />);
    </script>

</body>
</html>
