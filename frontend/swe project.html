<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smithy</title>
    <link rel="stylesheet" href="swe project.css">
</head>
<body>
    <div id="root"></div>
<script src = "https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src = "https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState } = React;
        const MATERIALS = {
            stone: "./materials/stone.png",
            wood: "./materials/wood.png",
            water: "./materials/water.png",
        }
        function Sidebar({onDragStart}){
            return(
                <aside id="sidebar" className="page-content" aria-label="Component sidebar">
                    <h3>Materials</h3>
                    <div className="sidebar-list">
                        {Object.entries(MATERIALS).map(([name,src])=>(   
                            <div className="items" key={name}>  
                                <img 
                                    className="draggable" 
                                    src={src}
                                    key={name}
                                    alt={name}
                                    draggable="true" 
                                    onDragStart={(e)=>onDragStart(e,name)}
                                />
                                <p className="item-name">{name}</p>  
                            </div>
                        ))}
        
                    </div>
                </aside>
            );
        }

        function Workspace({workspaceItems, onDrop, onDragOver, onItemDrag, onItemDrop}){
            return(

                <main id="workspace" className="page-content" tabIndex="0" aria-label="Workspace (drop area)"
                    onDrop={onDrop}
                    onDragOver={onDragOver}>
                    {workspaceItems.length === 0 ? (
                        <p className="workspace-placeholder"><b>Drag items here</b></p>
                    ) : (workspaceItems.map((item,i) => (
                        <img 
                            src={`./materials/${item.name}.png`}
                            key={i} 
                            className="workspace-item"
                            style={{
                                position: 'absolute',
                                left: `${item.x}px`,
                                top: `${item.y}px`,
                                cursor: 'move'
                            }}
                            draggable="true"
                            onDragStart={(e) => onItemDrag(e, i)}
                            onDragOver={(e) => e.preventDefault()}
                            onDrop={(e) => onItemDrop(e, i)}
                        />
                    )))}
                </main>
            );
        }
        // Login Modal Component
        function LoginModal({ isOpen, onClose, onLogin }) {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const endpoint = isLoginMode ? 'auth/login/' : 'auth/register/';
                const payload = isLoginMode 
                    ? { username, password }
                    : { username, email, password };

                try {
                    const response = await fetch(`http://localhost:8000/api/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    console.log('Server response:', response.status, data);

                    if (response.ok) {
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('user_data', JSON.stringify(data.user));
                        onLogin(data.user, data.token);
                        onClose();
                        setUsername('');
                        setEmail('');
                        setPassword('');
                    } else {
                        setError(data.error || 'Something went wrong');
                    }
                } catch (err) {
                    console.error('Registration/Login Error:', err);
                    setError(`Network error: ${err.message}. Please check if the server is running on http://localhost:8000`);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2 className="modal-title">
                            {isLoginMode ? 'Welcome, Noble Knight!' : 'Join the Round Table'}
                        </h2>
                        {error && (
                            <div style={{color: '#ff6b6b', marginBottom: '15px', textAlign: 'center'}}>
                                {error}
                            </div>
                        )}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Username</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                />
                            </div>
                            {!isLoginMode && (
                                <div className="form-group">
                                    <label className="form-label">Email</label>
                                    <input 
                                        type="email"
                                        className="form-input"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                    />
                                </div>
                            )}
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input 
                                    type="password"
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="btn-container">
                                <button type="submit" className="btn-primary" disabled={loading}>
                                    {loading ? 'Please wait...' : (isLoginMode ? 'Login' : 'Register')}
                                </button>
                                <button type="button" className="btn-secondary" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                        <button 
                            type="button" 
                            className="forgot-password-btn"
                            onClick={() => setIsLoginMode(!isLoginMode)}
                        >
                            {isLoginMode ? 'Need an account? Register here' : 'Already have an account? Login here'}
                        </button>
                    </div>
                </div>
            );
        }

        function App(){
            const [workspaceItems, setWorkspaceItems] = useState([]);
            const [draggingIndex, setDraggingIndex] = useState(null);
            const [user, setUser] = useState(null);
            const [authToken, setAuthToken] = useState(null);
            const [showLoginModal, setShowLoginModal] = useState(false);

            // Check for existing authentication on page load
            useEffect(() => {
                const token = localStorage.getItem('auth_token');
                const userData = localStorage.getItem('user_data');
                if (token && userData) {
                    setAuthToken(token);
                    setUser(JSON.parse(userData));
                }
            }, []);

            const handleLogin = (userData, token) => {
                setUser(userData);
                setAuthToken(token);
            };

            const handleLogout = async () => {
                try {
                    if (authToken) {
                        await fetch('http://localhost:8000/api/auth/logout/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${authToken}`,
                                'Content-Type': 'application/json',
                            }
                        });
                    }
                } catch (err) {
                    console.error('Logout error:', err);
                } finally {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    setUser(null);
                    setAuthToken(null);
                }
            };
            
            const handleDragStart = (e, item) => {
                e.dataTransfer.setData("text/plain", item);
                e.dataTransfer.effectAllowed = "copy";
            };
            
            const handleItemDrag = (e, index) => {
                setDraggingIndex(index);
                const item = workspaceItems[index];
                if (item) e.dataTransfer.setData('text/plain', item.name);
                e.dataTransfer.effectAllowed = "move";
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                const workspace = document.getElementById("workspace");
                const rect = workspace.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (draggingIndex !== null) {
                    setWorkspaceItems((prevItems) => {
                        const newItems = [...prevItems];
                        newItems[draggingIndex] = {
                            ...newItems[draggingIndex],
                            x: x - 50, 
                            y: y - 20
                        };
                        return newItems;
                    });
                    setDraggingIndex(null);
                } else {
                    const item = e.dataTransfer.getData("text/plain");
                    if (item) {
                        setWorkspaceItems((prevItems) => [...prevItems, {
                            name: item,
                            x: x - 50,
                            y: y - 20
                        }]);
                    }
                }
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
            };
            const API_BASE = 'http://localhost:8000/api';
            const [message, setMessage] = useState('');

            function showMessage(msg){
                setMessage(msg);
                setTimeout(()=> setMessage(''), 3500);
            }

            // called when a workspace item has another item dropped onto it
            const handleItemDrop = async (e, targetIndex) => {
                e.preventDefault();
                const otherName = e.dataTransfer.getData('text/plain');
                if (!otherName) return;
                const target = workspaceItems[targetIndex];
                if (!target || target.name === otherName) return;

                try{
                    const headers = {'Content-Type':'application/json'};
                    if (authToken) {
                        headers['Authorization'] = `Token ${authToken}`;
                    }
                    
                    const resp = await fetch(API_BASE + '/combine/', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ item1_name: target.name, item2_name: otherName })
                    });
                    const data = await resp.json();
                    if (resp.ok){
                        showMessage(data.message || JSON.stringify(data));
                        if (data.is_new && data.new_item){
                            // add new item near the target
                            setWorkspaceItems(prev => [...prev, {
                                name: data.new_item,
                                x: (target.x || 0) + 40,
                                y: (target.y || 0) + 10
                            }]);
                        }
                    } else {
                        showMessage('Error: ' + (data.error || resp.statusText));
                    }
                } catch(err){
                    showMessage('Network error: ' + err.message);
                }
            };
           return(
            <React.Fragment>
                {/* Login/User Status */}
                <div className="login-container">
                    {user ? (
                        <div className="user-status">
                            <span className="user-name">Sir {user.username}</span>
                            <button className="logout-btn" onClick={handleLogout}>
                                Logout
                            </button>
                        </div>
                    ) : (
                        <button className="login-btn" onClick={() => setShowLoginModal(true)}>
                            Login
                        </button>
                    )}
                </div>

                <Sidebar onDragStart={handleDragStart}/>
                    <Workspace 
                    workspaceItems={workspaceItems}
                    onDrop={handleDrop}
                    onDragOver={handleDragOver}
                        onItemDrag={handleItemDrag}
                        onItemDrop={handleItemDrop}
                />  

                <LoginModal 
                    isOpen={showLoginModal}
                    onClose={() => setShowLoginModal(false)}
                    onLogin={handleLogin}
                />

                    {message && (
                        <div id="api-message-box" style={{
                            position: 'fixed',
                            right: '16px',
                            bottom: '16px',
                            padding: '10px 14px',
                            background: 'rgba(0,0,0,0.8)',
                            color: '#fff',
                            borderRadius: '6px',
                            zIndex: 9999
                        }}>{message}</div>
                    )}
            </React.Fragment>);
           
        }
        const container=document.getElementById("root");
        const root=ReactDOM.createRoot(container);
        root.render(<App />);
    </script>

</body>
</html>
